<html>
<body>

<style>
.col{
	padding: 1em;
	border: 1px solid #CCC;
	float: left;
	display: table-cell;
}
</style>

<div style="float: left; display: table-cell">
	<div>
		Columns: <input id="size" value="6" />
	</div>
	<div>
		Min: <input id="min" value="1" />
	</div>
	<div>
		Max: <input id="max" value="1000000" />
	</div>
	<div>
		Function: <textarea id="func" style="width: 400px; height: 300px;"></textarea> <span id="func_trouble"></span>
	</div>
	<div>
		<button id="goer">Go</button>
		<button id="stopper">Stop</button>
		<button id="clearer">Clear</button>
	</div>
</div>

<div id="colbox"></div>
<div style="clear: both"></div>

<script type="text/javascript">
(function(){

	var speed = 100;

	var size = 6;
	var size_input = document.getElementById('size');
	var func_input = document.getElementById('func');
	var func_trouble = document.getElementById('func_trouble');
	var goer = document.getElementById('goer');
	var stopper = document.getElementById('stopper');
	var clearer = document.getElementById('clearer');
	var min = document.getElementById('min');
	var max = document.getElementById('max');

	var colbox = document.getElementById('colbox');
	var cols = [];
	var cells = [];
	var ints = [];
	var ints_used = {};
	var ints_index = 0;

	var make_col = function(){
	  var col = document.createElement('div');
	  col.className = 'col';
	  return col;
	};

	var get_col = function(i){
	  if (cols[i])
	    return cols[i];
	  cols[i] = colbox.appendChild(make_col());
	  cols[i].appendChild(document.createElement('div')).innerHTML = "Column " + i + ":";
	  cols[i].add = col_adder;
	  return cols[i];
	};

	var col_adder = function(cell){
		highlight_cell(cell, {border: "1px solid red"});
		if (this != cell.parentNode)
			move(cell, this);
	};

	var mapper = function(n){
		for (var i = size; i >= 1; i--)
			if (n % i == 0)
				return i;
	};
	func_input.value = mapper + '';

	var get_cell = function(i){
		if (cells[i])
			return cells[i];
		cells[i] = make_cell();
		cells[i].innerHTML = i;
		cells[i].value = i;
		return cells[i];
	};

	var run_mapper = function(i, mapper){
		var m = mapper(i);
		if (m === null)
			alert("Nothing returned from mapper for " + i);
		var cell = get_cell(i);
		var col = get_col(m);
		col.add(cell);
		return cell;
	};

	var make_shrinker = function(){
		var shrinker = document.createElement('div')
		shrinker.innerHTML = '&nbsp;';
		return make_changer(shrinker, true);
	};

	var make_grower = function(cell){
		return make_changer(cell);
	};

	var make_changer = function(element, shrink){
		element.style.height = '1em';
		element.style.overflowY = 'hidden';
		var top = 4;
		var i = shrink ? top : 0;
		var intr = setInterval(function(){
			i += shrink ? -1 : 1;
			if (i < 0 || i > top){
				clearInterval(intr);
				if (shrink)
					element.parentNode.removeChild(element);
				return;
			}
			element.style.height = (i / top) + 'em';
		}, 50);
		return element;
	};

	var move = function(cell, col){
		if (cell.parentNode){
			cell.parentNode.replaceChild(make_shrinker(), cell);
			highlight_cell(cell, {backgroundColor: "#88F"});
		}
		else{
			highlight_cell(cell, {backgroundColor: "#8F8"});
		}
		for (var i = 0; i < col.childNodes.length; i++){
			if (col.childNodes[i].value && col.childNodes[i].value > cell.value){
				col.insertBefore(make_grower(cell), col.childNodes[i]);
				return;
			}
		}
		col.appendChild(make_grower(cell));
	};

	var highlight_cell = function(cell, style){
		for (var i in style)
			cell.style[i] = style[i];
		setTimeout(function(){
			for (var i in style)
				cell.style[i] = '';
		}, speed / 2);
	};

	var make_cell = function(){
		return document.createElement('div');
	};

	var hopper = function(){
		ints_index++;
		if (! ints[ints_index]){
			var next;
			var a = parseInt(min.value);
			var b = parseInt(max.value);
			do{
				next = parseInt(Math.random() * (b - a) + b);
			} while (ints_used[next]);
			ints[ints_index] = next;
			ints_used[next] = 1;
		}
		return ints[ints_index];
	};

	var runner = function(mapper){
			stop();
			runner.interval = setInterval(function(){
				var cell = run_mapper(hopper(), mapper);
			}, speed);
	}

	var stop = function(){
		if (runner.interval)
			clearInterval(runner.interval);
		delete runner.interval;
		ints_index = 0;
	};

	var clear_her = function(){
		stop();
		colbox.innerHTML = '';
		cols = [];
		cells = [];
		ints = [];
		ints_used = {};
		ints_index = 0;
	};

	runner(mapper);

	goer.onclick = function(){
		size = size_input.value;
		func_trouble.innerText = '';
		var custom;
		try{
			eval('custom = ' + func_input.value);
		}
		catch(e){
			func_trouble.innerText = e + '';
		}
		if (custom)
			runner(custom);
	};

	stopper.onclick = stop;
	clearer.onclick = clear_her;

})();
</script>

</body>
</html>