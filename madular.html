<html>
<body>

<style>
.col{
	padding: 1em;
	border: 1px solid #CCC;
	float: left;
	display: table-cell;
}
</style>

<div style="float: left; display: table-cell">
	<div>
		Columns: <input id="size" value="6" />
	</div>
	<div>
		Start At: <input id="startat" value="1" />
	</div>
	<div>
		Step: <input id="step" value="1" />
	</div>
	<div>
		Function: <textarea id="func" style="width: 600px; height: 300px;"></textarea> <span id="func_trouble"></span>
	</div>
	<div>
		<button id="goer">Go</button>
		<button id="stopper">Stop</button>
		<button id="clearer">Clear</button>
	</div>
</div>

<div id="colbox"></div>
<div style="clear: both"></div>

<script type="text/javascript">
(function(){

	var size = 6;
	var size_input = document.getElementById('size');
	var func_input = document.getElementById('func');
	var func_trouble = document.getElementById('func_trouble');
	var goer = document.getElementById('goer');
	var stopper = document.getElementById('stopper');
	var clearer = document.getElementById('clearer');
	var startat = document.getElementById('startat');
	var step = document.getElementById('step');

	var colbox = document.getElementById('colbox');
	var cols = [];
	var cells = [];

	var make_col = function(){
	  var col = document.createElement('div');
	  col.className = 'col';
	  return col;
	};

	var get_col = function(i){
	  if (cols[i])
	    return cols[i];
	  cols[i] = colbox.appendChild(make_col());
	  cols[i].appendChild(document.createElement('div')).innerHTML = "Column " + i + ":";
	  return cols[i];
	};

	var mapper = function(n){
		for (var i = size; i >= 1; i--)
			if (n % i == 0)
				return i;
	};
	func_input.value = mapper + '';

	var get_cell = function(i){
		if (cells[i])
			return cells[i];
		cells[i] = make_cell();
		cells[i].innerHTML = i;
		return cells[i];
	};

	var run_mapper = function(i, mapper){
		var m = mapper(i);
		if (m === null)
			alert("Nothing returned from mapper for " + i);
		var cell = get_cell(i);
		var col = get_col(m);
		if (col != cell.parentNode)
			move(cell, col);
		return cell;
	};

	var move = function(cell, col){
		if (cell.parentNode){
			var shrinker = document.createElement('div')
			shrinker.innerHTML = '&nbsp;';
			shrinker.style.height = '1em';
			shrinker.style.overflowY = 'hidden';
			var top = 4;
			var i = top;
			var intr = setInterval(function(){
				i--;
				if (i < 0){
					clearInterval(intr);
					return;
				}
				shrinker.style.height = (i / top) + 'em';
			}, 50);
			cell.parentNode.replaceChild(shrinker, cell);
		}
		col.appendChild(cell);
	};

	var make_cell = function(){
		return document.createElement('div');
	};

	var runner = function(mapper){
			var i = parseInt(startat.value);
			var speed = 100;
			if (runner.interval)
				clearInterval(runner.interval);
			runner.interval = setInterval(function(){
				var cell = run_mapper(i, mapper);
				cell.style.border = "1px solid blue";
				setTimeout(function(){
					cell.style.border = "1px solid white";
				}, speed / 2);
				i += parseInt(step.value);
			}, speed);
	}

	var stop = function(){
		if (runner.interval)
			clearInterval(runner.interval);
		delete runner.interval;
	};

	var clear_her = function(){
		stop();
		colbox.innerHTML = '';
		cols = [];
		cells = [];
	};

	runner(mapper);

	goer.onclick = function(){
		size = size_input.value;
		func_trouble.innerText = '';
		var custom;
		try{
			eval('custom = ' + func_input.value);
		}
		catch(e){
			func_trouble.innerText = e + '';
		}
		if (custom)
			runner(custom);
	};

	stopper.onclick = stop;
	clearer.onclick = clear_her;

})();
</script>

</body>
</html>